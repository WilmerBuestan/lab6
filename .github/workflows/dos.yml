name: CI Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4  # Actualizado a v4
        with:
          node-version: '20'

      - name: Instalar las dependencias
        run: npm install

      - name: Lint del codigo
        run: npm run lint

      - name: Ejecutar pruebas
        run: npm test

      - name: Simular despliegue
        run: echo "Despliegue simulado exitoso"

      - name: Generar reporte de cobertura (Simulado)
        if: success()
        run: npm run coverage-report

      - name: Publicar reporte de cobertura
        if: success()
        uses: actions/upload-artifact@v4  # CORREGIDO: v4
        with:
          name: coverage-report
          path: coverage/  # AGREGADO: Ruta de la carpeta a subir

      - name: Subir cobertura de codigo (Simulado)
        if: success()
        run: npm run coverage-upload

      - name: Ejecutar analisis de seguridad
        run: npm run security-scan

      # Nota: Para subir el reporte de seguridad, primero debe existir un archivo.
      # Como es simulado, crearemos uno al vuelo.
      - name: Crear reporte de seguridad dummy
        run: echo "Reporte de seguridad seguro" > security-report.txt

      - name: Publicar resultados del analisis de seguridad
        uses: actions/upload-artifact@v4 # CORREGIDO: v4
        with:
          name: security-scan-report
          path: security-report.txt # AGREGADO

      - name: Verificar dependencias vulnerables
        # Usamos 'npm audit' sin fix para que solo reporte, 
        # o 'true' para que no falle el pipeline si encuentra algo leve.
        run: npm audit || true 

      - name: Ejecutar pruebas en paralelo
        run: npm run test-parallel

      - name: Verificar estandares de codigo
        run: npm run code-standards-check

      - name: Ejecutar pruebas de integracion
        run: npm run integration-tests

      - name: Ejecutar pruebas de regresion
        run: npm run regression-tests

      - name: Limpiar el entorno
        run: npm run clean

      - name: Notificar exito
        if: success()
        run: echo "La integración continua se ha completado con éxito."
      
      - name: Notificar fallo
        if: failure()
        run: echo "La integración continua ha fallado."